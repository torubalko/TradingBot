#pragma once
#include <functional>
#include <string_view>
#include <memory>
#include "simdjson.h"
#include "../Types.h"
#include "../Parsing/FastParser.h"

namespace TradingBot::Core::Network {

    // ???????????????????????????????????????????????????????????????
    // DataFeedManager: Маршрутизация сообщений по типу стрима
    // ???????????????????????????????????????????????????????????????
    class DataFeedManager {
    public:
        // Callbacks для различных типов событий
        using DepthUpdateCallback = std::function<void(const OrderBookUpdate&)>;
        using AggTradeCallback = std::function<void(const AggTrade&)>;
        using ErrorCallback = std::function<void(std::string_view error)>;

        DataFeedManager();
        ~DataFeedManager() = default;

        // ???????????????????????????????????????????????????????????????
        // Установка обработчиков
        // ???????????????????????????????????????????????????????????????
        void SetDepthUpdateHandler(DepthUpdateCallback cb) {
            depthCallback_ = std::move(cb);
        }

        void SetAggTradeHandler(AggTradeCallback cb) {
            tradeCallback_ = std::move(cb);
        }

        void SetErrorHandler(ErrorCallback cb) {
            errorCallback_ = std::move(cb);
        }

        // ???????????????????????????????????????????????????????????????
        // Основной метод обработки сообщений (HOT PATH)
        // Принимает string_view для zero-copy
        // ???????????????????????????????????????????????????????????????
        void ProcessMessage(std::string_view rawJson);

    private:
        // ???????????????????????????????????????????????????????????????
        // Обработка Combined Stream wrapper
        // {"stream":"btcusdt@depth","data":{...}}
        // ???????????????????????????????????????????????????????????????
        void ProcessCombinedStream(simdjson::ondemand::document& doc);

        // ???????????????????????????????????????????????????????????????
        // Обработчики конкретных типов событий
        // ???????????????????????????????????????????????????????????????
        void HandleDepthUpdate(simdjson::ondemand::document& doc);
        void HandleAggTrade(simdjson::ondemand::document& doc);

        // ???????????????????????????????????????????????????????????????
        // Members
        // ???????????????????????????????????????????????????????????????
        simdjson::ondemand::parser parser_;
        
        // Pre-allocated структуры для переиспользования (избегаем allocations)
        OrderBookUpdate cachedUpdate_;
        AggTrade cachedTrade_;

        // Callbacks
        DepthUpdateCallback depthCallback_;
        AggTradeCallback tradeCallback_;
        ErrorCallback errorCallback_;
    };

} // namespace TradingBot::Core::Network
