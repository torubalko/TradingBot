#pragma once
#include <string>
#include <memory>
#include <boost/asio.hpp>
#include <boost/asio/ssl.hpp>
#include <boost/beast.hpp>
#include <boost/beast/ssl.hpp>

namespace TradingBot::Core::Network {

    namespace beast = boost::beast;
    namespace http = beast::http;
    namespace net = boost::asio;
    namespace ssl = net::ssl;
    using tcp = net::ip::tcp;

    // ???????????????????????????????????????????????????????????????
    // HttpResponse: структура HTTP ответа
    // ???????????????????????????????????????????????????????????????
    struct HttpResponse {
        int statusCode{0};
        std::string body;
        std::string errorMessage;

        bool IsSuccess() const {
            return statusCode >= 200 && statusCode < 300;
        }
    };

    // ???????????????????????????????????????????????????????????????
    // HttpClient: упрощённый HTTP/HTTPS клиент на boost::beast
    // ???????????????????????????????????????????????????????????????
    class HttpClient {
    public:
        HttpClient();
        ~HttpClient();

        // ???????????????????????????????????????????????????????????????
        // HTTP GET (instance method)
        // ???????????????????????????????????????????????????????????????
        HttpResponse Get(const std::string& host,
                        const std::string& target,
                        const std::string& apiKey = "");

        // ???????????????????????????????????????????????????????????????
        // HTTP POST
        // ???????????????????????????????????????????????????????????????
        HttpResponse Post(const std::string& host,
                         const std::string& target,
                         const std::string& body,
                         const std::string& apiKey = "");

        // ???????????????????????????????????????????????????????????????
        // HTTP DELETE
        // ???????????????????????????????????????????????????????????????
        HttpResponse Delete(const std::string& host,
                           const std::string& target,
                           const std::string& apiKey = "");

        // ???????????????????????????????????????????????????????????????
        // Configuration
        // ???????????????????????????????????????????????????????????????
        void SetTimeout(int timeoutMs) {
            timeoutMs_ = timeoutMs;
        }

        // ???????????????????????????????????????????????????????????????
        // Static helper для обратной совместимости (legacy API)
        // Использовать HttpClient::GetSimple(host, target) вместо старого API
        // ???????????????????????????????????????????????????????????????
        static std::string GetSimple(const std::string& host, const std::string& target);

    private:
        // ???????????????????????????????????????????????????????????????
        // Internal Request Method
        // ???????????????????????????????????????????????????????????????
        HttpResponse ExecuteRequest(
            http::verb method,
            const std::string& host,
            const std::string& target,
            const std::string& body,
            const std::string& apiKey);

        // ???????????????????????????????????????????????????????????????
        // Members
        // ???????????????????????????????????????????????????????????????
        net::io_context ioc_;
        ssl::context sslCtx_{ssl::context::tlsv12_client};
        int timeoutMs_{10000};
    };

} // namespace TradingBot::Core::Network
