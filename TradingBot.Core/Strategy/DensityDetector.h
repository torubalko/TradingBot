#pragma once
#include <array>
#include <span>
#include <algorithm>
#include "../OrderBook/LocalOrderBook.h"

namespace TradingBot::Core::Strategy {

    // ???????????????????????????????????????????????????????????????
    // Side: Сторона стакана
    // ???????????????????????????????????????????????????????????????
    enum class Side {
        BID,
        ASK
    };

    // ???????????????????????????????????????????????????????????????
    // DensityLevel: Уровень плотности (стена ликвидности)
    // ???????????????????????????????????????????????????????????????
    struct DensityLevel {
        double price{0.0};
        double volume{0.0};          // Объём на уровне (BTC)
        double volumeQuote{0.0};     // Объём в USDT
        Side side{Side::BID};
        double distanceFromMid{0.0}; // Расстояние от mid price в %
        double significance{0.0};    // Коэффициент значимости (для сортировки)
    };

    // ???????????????????????????????????????????????????????????????
    // DensityDetector: Поиск "стен ликвидности" в стакане
    // ???????????????????????????????????????????????????????????????
    class DensityDetector {
    public:
        DensityDetector();
        ~DensityDetector() = default;

        // ???????????????????????????????????????????????????????????????
        // Основной метод: сканирование стакана (вызывается каждый тик)
        // ???????????????????????????????????????????????????????????????
        void Scan(const OrderBook::LocalOrderBook& book);

        // ???????????????????????????????????????????????????????????????
        // Получение найденных плотностей (read-only)
        // ???????????????????????????????????????????????????????????????
        std::span<const DensityLevel> GetDensities() const {
            return std::span<const DensityLevel>(densities_.data(), densityCount_);
        }

        size_t GetDensityCount() const {
            return densityCount_;
        }

        // ???????????????????????????????????????????????????????????????
        // Конфигурация (можно изменить в runtime)
        // ???????????????????????????????????????????????????????????????
        void SetVolumeThresholdMultiplier(double multiplier) {
            volumeThresholdMultiplier_ = multiplier;
        }

        void SetScanDepth(int depth) {
            scanDepth_ = depth;
        }

        void SetMinVolumeUsdt(double minVolume) {
            minVolumeUsdt_ = minVolume;
        }

    private:
        // ???????????????????????????????????????????????????????????????
        // Internal Helpers
        // ???????????????????????????????????????????????????????????????
        
        // Вычисление среднего объёма в топ-N уровней
        double CalculateAverageVolume(const std::vector<OrderBook::PriceLevel>& levels, 
                                      int depth) const;

        // Сканирование одной стороны стакана (bids или asks)
        void ScanSide(const std::vector<OrderBook::PriceLevel>& levels,
                     Side side,
                     double midPrice,
                     double averageVolume);

        // ???????????????????????????????????????????????????????????????
        // Configuration
        // ???????????????????????????????????????????????????????????????
        double volumeThresholdMultiplier_{5.0};  // 5x от среднего объёма
        int scanDepth_{100};                      // Сканировать топ-100 уровней
        double minVolumeUsdt_{10000.0};          // Минимум 10k USDT для плотности

        // ???????????????????????????????????????????????????????????????
        // PRE-ALLOCATED Storage
        // ???????????????????????????????????????????????????????????????
        std::array<DensityLevel, 64> densities_;  // Max 64 плотности
        size_t densityCount_{0};
    };

} // namespace TradingBot::Core::Strategy
