#pragma once
#include <array>
#include <span>
#include <vector>
#include <chrono>
#include "../Types.h"
#include "DensityDetector.h"

namespace TradingBot::Core::Strategy {

    // ???????????????????????????????????????????????????????????????
    // TakerFlowMetrics: Метрики потока агрессивных ордеров
    // ???????????????????????????????????????????????????????????????
    struct TakerFlowMetrics {
        double buyVolume{0.0};           // Cumulative taker buy volume (BTC)
        double sellVolume{0.0};          // Cumulative taker sell volume (BTC)
        double buyVolumeQuote{0.0};      // В USDT
        double sellVolumeQuote{0.0};     // В USDT
        double imbalanceRatio{0.0};      // (buy - sell) / (buy + sell)
        uint32_t buyCount{0};            // Количество buy trades
        uint32_t sellCount{0};           // Количество sell trades
    };

    // ???????????????????????????????????????????????????????????????
    // TakerFlowSignal: Сигнал для стратегии
    // ???????????????????????????????????????????????????????????????
    struct TakerFlowSignal {
        double buyPressure{0.0};         // 0.0 - 1.0
        double sellPressure{0.0};        // 0.0 - 1.0
        bool largeBuyerDetected{false};  // Trade > threshold
        bool largeSellerDetected{false};
        bool densityUnderAttack{false};  // Крупные ордера бьют в уровень
        double attackedPrice{0.0};       // Цена атакуемого уровня
    };

    // ???????????????????????????????????????????????????????????????
    // TakerFlowAnalyzer: Анализ потока агрессивных ордеров
    // ???????????????????????????????????????????????????????????????
    class TakerFlowAnalyzer {
    public:
        TakerFlowAnalyzer();
        ~TakerFlowAnalyzer() = default;

        // ???????????????????????????????????????????????????????????????
        // Обработка каждого aggTrade (вызывается на каждую сделку)
        // ???????????????????????????????????????????????????????????????
        void ProcessTrade(const AggTrade& trade);

        // ???????????????????????????????????????????????????????????????
        // Получение текущих метрик (скользящее окно)
        // ???????????????????????????????????????????????????????????????
        TakerFlowMetrics GetMetrics() const;

        // ???????????????????????????????????????????????????????????????
        // Получение сигнала для стратегии
        // ???????????????????????????????????????????????????????????????
        TakerFlowSignal GetSignal(const std::span<const DensityLevel>& densities);

        // ???????????????????????????????????????????????????????????????
        // Конфигурация
        // ???????????????????????????????????????????????????????????????
        void SetLargeTradeThreshold(double threshold) {
            largeTradeThreshold_ = threshold;
        }

        void SetWindowSizeMs(int windowMs) {
            windowSizeMs_ = windowMs;
        }

    private:
        // ???????????????????????????????????????????????????????????????
        // Internal Helpers
        // ???????????????????????????????????????????????????????????????
        
        // Очистка устаревших сделок из ring buffer
        void CleanOldTrades();

        // Вычисление метрик на основе текущего буфера
        TakerFlowMetrics CalculateMetrics() const;

        // Проверка атаки на уровень плотности
        bool IsLevelUnderAttack(const DensityLevel& level, 
                               uint64_t currentTimeMs) const;

        // ???????????????????????????????????????????????????????????????
        // Configuration
        // ???????????????????????????????????????????????????????????????
        double largeTradeThreshold_{10.0};  // BTC (крупная сделка)
        int windowSizeMs_{1000};             // 1 секунда скользящее окно

        // ???????????????????????????????????????????????????????????????
        // PRE-ALLOCATED Ring Buffer для trades
        // ???????????????????????????????????????????????????????????????
        std::array<AggTrade, 4096> tradeBuffer_;
        size_t tradeHead_{0};  // Индекс для записи
        size_t tradeTail_{0};  // Индекс для чтения
        size_t tradeCount_{0}; // Количество элементов в буфере

        // Cache для последних крупных сделок
        bool lastLargeBuyDetected_{false};
        bool lastLargeSellerDetected_{false};
    };

} // namespace TradingBot::Core::Strategy
