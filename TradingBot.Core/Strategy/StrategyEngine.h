#pragma once
#include <memory>
#include "DensityDetector.h"
#include "TakerFlowAnalyzer.h"
#include "../OrderBook/LocalOrderBook.h"

namespace TradingBot::Core::Strategy {

    // ???????????????????????????????????????????????????????????????
    // StrategySignal: Сигналы стратегии
    // ???????????????????????????????????????????????????????????????
    enum class StrategySignal {
        None,
        LongEntry,    // Вход в лонг (отскок от bid wall)
        ShortEntry,   // Вход в шорт (отскок от ask wall)
        ExitLong,     // Закрытие лонга
        ExitShort     // Закрытие шорта
    };

    // ???????????????????????????????????????????????????????????????
    // OrderRequest: Запрос на создание ордера (заглушка для будущего)
    // ???????????????????????????????????????????????????????????????
    struct OrderRequest {
        StrategySignal signal{StrategySignal::None};
        double entryPrice{0.0};
        double quantity{0.0};
        double stopLoss{0.0};
        double takeProfit{0.0};
    };

    // ???????????????????????????????????????????????????????????????
    // StrategyConfig: Конфигурация стратегии
    // ???????????????????????????????????????????????????????????????
    struct StrategyConfig {
        // Параметры входа
        double minDistanceToWall{0.5};      // Минимальная дистанция до стены (%)
        double maxDistanceToWall{2.0};      // Максимальная дистанция до стены (%)
        
        // Порог imbalance для подтверждения отскока
        double minImbalanceForEntry{0.3};   // Минимум 30% дисбаланса
        
        // Фильтр атаки на стену
        bool filterWallUnderAttack{true};   // Не входить, если стена под атакой
        
        // Risk Management (заглушка)
        double defaultQuantity{0.01};       // BTC
        double stopLossPercent{0.5};        // 0.5% от входа
        double takeProfitPercent{1.0};      // 1.0% от входа
    };

    // ???????????????????????????????????????????????????????????????
    // StrategyEngine: Главный класс стратегии "Отскок от плотности"
    // ???????????????????????????????????????????????????????????????
    class StrategyEngine {
    public:
        StrategyEngine();
        ~StrategyEngine() = default;

        // ???????????????????????????????????????????????????????????????
        // Основной метод: вызывается каждый тик
        // ???????????????????????????????????????????????????????????????
        void OnTick(const OrderBook::LocalOrderBook& spotBook,
                   const OrderBook::LocalOrderBook& futuresBook);

        // ???????????????????????????????????????????????????????????????
        // Обработка входящих aggTrade
        // ???????????????????????????????????????????????????????????????
        void OnAggTrade(const AggTrade& trade);

        // ???????????????????????????????????????????????????????????????
        // Получение текущего сигнала
        // ???????????????????????????????????????????????????????????????
        StrategySignal GetSignal() const {
            return currentSignal_;
        }

        // ???????????????????????????????????????????????????????????????
        // Параметры входа (для RiskManager/OMS)
        // ???????????????????????????????????????????????????????????????
        OrderRequest GetPendingOrder() const {
            return pendingOrder_;
        }

        // ???????????????????????????????????????????????????????????????
        // Конфигурация
        // ???????????????????????????????????????????????????????????????
        void SetConfig(const StrategyConfig& config) {
            config_ = config;
        }

        const StrategyConfig& GetConfig() const {
            return config_;
        }

    private:
        // ???????????????????????????????????????????????????????????????
        // Логика стратегии "Отскок от плотности"
        // ???????????????????????????????????????????????????????????????
        
        // Поиск точки входа в лонг (отскок от bid wall)
        bool FindLongEntry(const OrderBook::LocalOrderBook& book,
                          const std::span<const DensityLevel>& densities,
                          const TakerFlowSignal& signal);

        // Поиск точки входа в шорт (отскок от ask wall)
        bool FindShortEntry(const OrderBook::LocalOrderBook& book,
                           const std::span<const DensityLevel>& densities,
                           const TakerFlowSignal& signal);

        // Проверка условий входа
        bool CheckEntryConditions(const DensityLevel& wall,
                                 double currentPrice,
                                 const TakerFlowSignal& signal,
                                 bool isLong) const;

        // Генерация OrderRequest
        void GenerateOrderRequest(StrategySignal signal,
                                 double entryPrice,
                                 double stopLoss,
                                 double takeProfit);

        // ???????????????????????????????????????????????????????????????
        // Members
        // ???????????????????????????????????????????????????????????????
        DensityDetector densityDetector_;
        TakerFlowAnalyzer takerAnalyzer_;

        // Состояние
        StrategySignal currentSignal_{StrategySignal::None};
        OrderRequest pendingOrder_;

        // Конфигурация
        StrategyConfig config_;
    };

} // namespace TradingBot::Core::Strategy
