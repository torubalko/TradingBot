#pragma once
#include <deque>
#include <atomic>
#include <memory>
#include <functional>
#include "LocalOrderBook.h"
#include "../Types.h"

namespace TradingBot::Core::OrderBook {

    // ???????????????????????????????????????????????????????????????
    // SyncState: Состояния синхронизации Order Book
    // ???????????????????????????????????????????????????????????????
    enum class SyncState {
        Disconnected,      // Нет соединения
        Buffering,         // Буферизация diff-обновлений
        AwaitingSnapshot,  // Ожидание REST snapshot
        Synchronizing,     // Склейка snapshot + buffer
        Live,              // Нормальная работа
        Resync             // Обнаружен gap, пересинхронизация
    };

    // ???????????????????????????????????????????????????????????????
    // DiffBufferEntry: Запись в буфере diff-обновлений
    // ???????????????????????????????????????????????????????????????
    struct DiffBufferEntry {
        int64_t firstUpdateId{0};  // U
        int64_t finalUpdateId{0};  // u
        OrderBookUpdate update;     // Копия данных (избегаем указателей для простоты)
    };

    // ???????????????????????????????????????????????????????????????
    // SnapshotSynchronizer: Реализация алгоритма синхронизации Binance
    // ???????????????????????????????????????????????????????????????
    class SnapshotSynchronizer {
    public:
        // Callbacks
        using SnapshotRequestCallback = std::function<void()>;
        using StateChangeCallback = std::function<void(SyncState)>;

        SnapshotSynchronizer(LocalOrderBook& orderBook);
        ~SnapshotSynchronizer() = default;

        // ???????????????????????????????????????????????????????????????
        // Lifecycle Management
        // ???????????????????????????????????????????????????????????????
        void Start();
        void Stop();
        void Reset();

        // ???????????????????????????????????????????????????????????????
        // Обработка входящих данных
        // ???????????????????????????????????????????????????????????????
        
        // Входящее diff-обновление (WebSocket)
        void OnDepthUpdate(const OrderBookUpdate& update);

        // Входящий snapshot (REST)
        void OnSnapshot(const OrderBookSnapshot& snapshot);

        // ???????????????????????????????????????????????????????????????
        // State Management
        // ???????????????????????????????????????????????????????????????
        SyncState GetState() const { 
            return state_.load(std::memory_order_acquire); 
        }

        bool IsLive() const { 
            return GetState() == SyncState::Live; 
        }

        int64_t GetLastUpdateId() const {
            return lastUpdateId_.load(std::memory_order_acquire);
        }

        // ???????????????????????????????????????????????????????????????
        // Callbacks Setup
        // ???????????????????????????????????????????????????????????????
        void SetSnapshotRequestCallback(SnapshotRequestCallback cb) {
            snapshotRequestCallback_ = std::move(cb);
        }

        void SetStateChangeCallback(StateChangeCallback cb) {
            stateChangeCallback_ = std::move(cb);
        }

    private:
        // ???????????????????????????????????????????????????????????????
        // Internal State Transitions
        // ???????????????????????????????????????????????????????????????
        void TransitionTo(SyncState newState);

        // ???????????????????????????????????????????????????????????????
        // Алгоритм синхронизации (4 этапа)
        // ???????????????????????????????????????????????????????????????

        // ЭТАП 1: Буферизация diff-обновлений
        void BufferUpdate(const OrderBookUpdate& update);

        // ЭТАП 2: Запрос snapshot (через callback)
        void RequestSnapshot();

        // ЭТАП 3: Синхронизация snapshot + buffered diffs
        void SynchronizeBuffer(int64_t snapshotLastUpdateId);

        // ЭТАП 4: Применение live updates
        void ApplyLiveUpdate(const OrderBookUpdate& update);

        // ???????????????????????????????????????????????????????????????
        // Gap Detection
        // ???????????????????????????????????????????????????????????????
        bool DetectGap(int64_t firstUpdateId) const;

        // ???????????????????????????????????????????????????????????????
        // Members
        // ???????????????????????????????????????????????????????????????
        LocalOrderBook& orderBook_;

        // State
        std::atomic<SyncState> state_{SyncState::Disconnected};
        std::atomic<int64_t> lastUpdateId_{0};

        // PRE-ALLOCATED буфер для diff-обновлений (этап буферизации)
        std::deque<DiffBufferEntry> diffBuffer_;
        const size_t maxBufferSize_{1000}; // Макс. размер буфера

        // Callbacks
        SnapshotRequestCallback snapshotRequestCallback_;
        StateChangeCallback stateChangeCallback_;

        // Флаг для запроса snapshot (один раз)
        bool snapshotRequested_{false};
    };

} // namespace TradingBot::Core::OrderBook
