#pragma once
#include <string>
#include <functional>
#include <memory>
#include "OrderTypes.h"
#include "ApiConfig.h"
#include "../Network/HttpClient.h"

namespace TradingBot::Core::Trading {

    // ???????????????????????????????????????????????????????????????
    // SubmitResult: Результат отправки ордера
    // ???????????????????????????????????????????????????????????????
    struct SubmitResult {
        bool success{false};
        uint64_t exchangeOrderId{0};
        std::string errorMessage;
    };

    // ???????????????????????????????????????????????????????????????
    // CancelResult: Результат отмены ордера
    // ???????????????????????????????????????????????????????????????
    struct CancelResult {
        bool success{false};
        std::string errorMessage;
    };

    // ???????????????????????????????????????????????????????????????
    // RestExecutor: HTTP клиент для Binance REST API
    // HMAC-SHA256 подпись, retry с exponential backoff
    // ???????????????????????????????????????????????????????????????
    class RestExecutor {
    public:
        RestExecutor(const ApiConfig& config);
        ~RestExecutor() = default;

        // ???????????????????????????????????????????????????????????????
        // Order Submission
        // ???????????????????????????????????????????????????????????????
        SubmitResult SubmitOrder(const OrderRequest& order);

        // ???????????????????????????????????????????????????????????????
        // Order Cancellation
        // ???????????????????????????????????????????????????????????????
        CancelResult CancelOrder(std::string_view symbol, uint64_t clientOrderId);

        // ???????????????????????????????????????????????????????????????
        // Query Order Status
        // ???????????????????????????????????????????????????????????????
        ExecutionReport QueryOrder(std::string_view symbol, uint64_t clientOrderId);

        // ???????????????????????????????????????????????????????????????
        // Test Connection (ping Binance API)
        // ???????????????????????????????????????????????????????????????
        bool TestConnection();

    private:
        // ???????????????????????????????????????????????????????????????
        // HMAC-SHA256 Signature
        // ???????????????????????????????????????????????????????????????
        std::string GenerateSignature(const std::string& queryString) const;

        // ???????????????????????????????????????????????????????????????
        // Build Query String (sorted parameters)
        // ???????????????????????????????????????????????????????????????
        std::string BuildOrderQueryString(const OrderRequest& order) const;

        // ???????????????????????????????????????????????????????????????
        // HTTP Requests with Retry
        // ???????????????????????????????????????????????????????????????
        Network::HttpResponse PostRequest(const std::string& endpoint, 
                                         const std::string& queryString);
        
        Network::HttpResponse GetRequest(const std::string& endpoint,
                                        const std::string& queryString);
        
        Network::HttpResponse DeleteRequest(const std::string& endpoint, 
                                           const std::string& queryString);

        // ???????????????????????????????????????????????????????????????
        // Retry Logic with Exponential Backoff
        // ???????????????????????????????????????????????????????????????
        Network::HttpResponse ExecuteWithRetry(
            std::function<Network::HttpResponse()> requestFunc);

        // ???????????????????????????????????????????????????????????????
        // Timestamp (milliseconds since epoch)
        // ???????????????????????????????????????????????????????????????
        uint64_t GetTimestampMs() const;

        // ???????????????????????????????????????????????????????????????
        // Members
        // ???????????????????????????????????????????????????????????????
        ApiConfig config_;
        std::unique_ptr<Network::HttpClient> httpClient_;
    };

} // namespace TradingBot::Core::Trading
