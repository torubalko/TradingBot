#pragma once
#include <atomic>
#include <array>
#include <chrono>
#include "OrderTypes.h"
#include "../Strategy/StrategyEngine.h"

namespace TradingBot::Core::Trading {

    // ???????????????????????????????????????????????????????????????
    // RiskConfig: Конфигурация параметров риска
    // ???????????????????????????????????????????????????????????????
    struct RiskConfig {
        // Position limits
        double maxPositionBtc{1.0};           // Макс. размер позиции
        double maxOrderSizeBtc{0.1};          // Макс. размер одного ордера
        double maxTotalExposureUsdt{50000.0}; // Общая экспозиция

        // Loss limits
        double maxDailyLossUsdt{500.0};       // Макс. дневная просадка
        double maxDrawdownPct{5.0};           // Макс. просадка от пика (%)

        // API limits (Binance: 1200 orders/min)
        int maxOrdersPerMinute{600};          // С запасом
        int maxCancelsPerMinute{600};

        // Price protection (Fat finger)
        double maxPriceDeviationPct{0.5};     // Макс. отклонение от рынка (%)
    };

    // ???????????????????????????????????????????????????????????????
    // RiskRejectReason: Причины отклонения ордера
    // ???????????????????????????????????????????????????????????????
    enum class RiskRejectReason {
        None,
        PositionLimitExceeded,
        OrderSizeTooLarge,
        DailyLossLimitReached,
        OrderRateLimitExceeded,
        PriceDeviationTooHigh,
        ExposureLimitExceeded,
        SystemHalted
    };

    // ???????????????????????????????????????????????????????????????
    // RiskCheckResult: Результат проверки риска
    // ???????????????????????????????????????????????????????????????
    struct RiskCheckResult {
        bool approved{false};
        RiskRejectReason reason{RiskRejectReason::None};
        const char* message{nullptr};  // Compile-time string (no allocation)
    };

    // ???????????????????????????????????????????????????????????????
    // RiskState: Состояние системы риска
    // ???????????????????????????????????????????????????????????????
    enum class RiskState {
        Normal,      // Все проверки пройдены
        ReduceOnly,  // Только закрытие позиций
        Halted       // Торговля остановлена
    };

    // ???????????????????????????????????????????????????????????????
    // RiskManager: Pre-trade validation и контроль лимитов
    // ???????????????????????????????????????????????????????????????
    class RiskManager {
    public:
        explicit RiskManager(const RiskConfig& config);
        ~RiskManager() = default;

        // ???????????????????????????????????????????????????????????????
        // Pre-trade Validation
        // ???????????????????????????????????????????????????????????????
        RiskCheckResult ValidateOrder(const Strategy::OrderRequest& order,
                                      double currentMarketPrice);

        // ???????????????????????????????????????????????????????????????
        // Position Management
        // ???????????????????????????????????????????????????????????????
        void UpdatePosition(const ExecutionReport& report);

        // ???????????????????????????????????????????????????????????????
        // Daily Counters Reset (00:00 UTC)
        // ???????????????????????????????????????????????????????????????
        void ResetDailyCounters();

        // ???????????????????????????????????????????????????????????????
        // State Management
        // ???????????????????????????????????????????????????????????????
        void SetState(RiskState newState) {
            state_.store(newState, std::memory_order_release);
        }

        RiskState GetState() const {
            return state_.load(std::memory_order_acquire);
        }

        void Halt() {
            SetState(RiskState::Halted);
        }

        // ???????????????????????????????????????????????????????????????
        // Telemetry Getters
        // ???????????????????????????????????????????????????????????????
        double GetCurrentPnL() const {
            return currentPnL_.load(std::memory_order_acquire);
        }

        double GetCurrentExposure() const {
            double spot = spotPosition_.load(std::memory_order_acquire);
            double futures = futuresPosition_.load(std::memory_order_acquire);
            return std::abs(spot) + std::abs(futures);
        }

        int GetOrdersThisMinute() const;

        // ???????????????????????????????????????????????????????????????
        // Configuration
        // ???????????????????????????????????????????????????????????????
        void SetConfig(const RiskConfig& config) {
            config_ = config;
        }

        const RiskConfig& GetConfig() const {
            return config_;
        }

    private:
        // ???????????????????????????????????????????????????????????????
        // Internal Checks
        // ???????????????????????????????????????????????????????????????
        bool CheckPositionLimit(double orderSize) const;
        bool CheckOrderSize(double orderSize) const;
        bool CheckDailyLoss() const;
        bool CheckOrderRate();
        bool CheckPriceDeviation(double orderPrice, double marketPrice) const;
        bool CheckExposureLimit(double additionalExposure) const;

        // ???????????????????????????????????????????????????????????????
        // Rate Limiting (Sliding Window via Ring Buffer)
        // ???????????????????????????????????????????????????????????????
        void RecordOrderTimestamp();

        // ???????????????????????????????????????????????????????????????
        // Members
        // ???????????????????????????????????????????????????????????????
        RiskConfig config_;

        // State
        std::atomic<RiskState> state_{RiskState::Normal};

        // PnL tracking
        std::atomic<double> currentPnL_{0.0};
        std::atomic<double> dailyPnL_{0.0};

        // Positions
        std::atomic<double> spotPosition_{0.0};      // BTC
        std::atomic<double> futuresPosition_{0.0};   // BTC

        // Rate limiting (ring buffer для timestamps)
        std::array<uint64_t, 1200> orderTimestamps_; // 1200 slots для 1 минуты
        std::atomic<size_t> orderIndex_{0};
    };

} // namespace TradingBot::Core::Trading
