#pragma once
#include <cstdint>
#include <atomic>
#include <array>
#include <algorithm>
#include "../Trading/RiskManager.h"

namespace TradingBot::Core::Infrastructure {

    // ???????????????????????????????????????????????????????????????
    // TelemetrySnapshot: —нимок метрик
    // ???????????????????????????????????????????????????????????????
    struct TelemetrySnapshot {
        // Latency (наносекунды)
        uint64_t wsToParseLatencyP50{0};
        uint64_t wsToParseLatencyP99{0};
        uint64_t parseToUpdateLatencyP50{0};
        uint64_t orderRoundtripLatencyP50{0};

        // Throughput
        uint32_t messagesPerSecond{0};
        uint32_t updatesPerSecond{0};
        uint32_t ordersPerMinute{0};

        // Trading
        double realizedPnL{0.0};
        double unrealizedPnL{0.0};
        double currentExposure{0.0};
        uint32_t activeOrders{0};

        // Risk state
        Trading::RiskState riskState{Trading::RiskState::Normal};
        double dailyLossUsed{0.0};     // % от лимита
        double positionUsed{0.0};      // % от лимита

        // System
        uint64_t memoryUsedBytes{0};
        uint32_t queueDepthNetwork{0};
        uint32_t queueDepthStrategy{0};
    };

    // ???????????????????????????????????????????????????????????????
    // TelemetryCollector: —бор и агрегаци€ метрик
    // ???????????????????????????????????????????????????????????????
    class TelemetryCollector {
    public:
        TelemetryCollector();
        ~TelemetryCollector() = default;

        // ???????????????????????????????????????????????????????????????
        // Latency Recording (HOT PATH)
        // ???????????????????????????????????????????????????????????????
        void RecordWsToParseLatency(uint64_t latencyNs);
        void RecordParseToUpdateLatency(uint64_t latencyNs);
        void RecordOrderRoundtripLatency(uint64_t latencyNs);

        // ???????????????????????????????????????????????????????????????
        // Throughput Counters (HOT PATH)
        // ???????????????????????????????????????????????????????????????
        void IncrementMessages() {
            messagesReceived_.fetch_add(1, std::memory_order_relaxed);
        }

        void IncrementUpdates() {
            updatesProcessed_.fetch_add(1, std::memory_order_relaxed);
        }

        void IncrementOrders() {
            ordersSubmitted_.fetch_add(1, std::memory_order_relaxed);
        }

        // ???????????????????????????????????????????????????????????????
        // Trading Metrics
        // ???????????????????????????????????????????????????????????????
        void SetRealizedPnL(double pnl) {
            realizedPnL_.store(pnl, std::memory_order_release);
        }

        void SetUnrealizedPnL(double pnl) {
            unrealizedPnL_.store(pnl, std::memory_order_release);
        }

        void SetExposure(double exposure) {
            currentExposure_.store(exposure, std::memory_order_release);
        }

        void SetActiveOrders(uint32_t count) {
            activeOrders_.store(count, std::memory_order_release);
        }

        // ???????????????????????????????????????????????????????????????
        // Risk Metrics
        // ???????????????????????????????????????????????????????????????
        void SetRiskState(Trading::RiskState state) {
            riskState_.store(state, std::memory_order_release);
        }

        void SetDailyLossUsed(double percent) {
            dailyLossUsed_.store(percent, std::memory_order_release);
        }

        void SetPositionUsed(double percent) {
            positionUsed_.store(percent, std::memory_order_release);
        }

        // ???????????????????????????????????????????????????????????????
        // Snapshot Generation (вызываетс€ периодически, не в hot path)
        // ???????????????????????????????????????????????????????????????
        TelemetrySnapshot GetSnapshot();

        // ???????????????????????????????????????????????????????????????
        // Reset Counters (каждую секунду дл€ throughput метрик)
        // ???????????????????????????????????????????????????????????????
        void ResetThroughputCounters();

        // ???????????????????????????????????????????????????????????????
        // Console Output (pretty print)
        // ???????????????????????????????????????????????????????????????
        void PrintSnapshot(const TelemetrySnapshot& snapshot) const;

    private:
        // ???????????????????????????????????????????????????????????????
        // Latency Tracking (ring buffer дл€ percentiles)
        // ???????????????????????????????????????????????????????????????
        static constexpr size_t LATENCY_BUFFER_SIZE = 1024;

        std::array<uint64_t, LATENCY_BUFFER_SIZE> wsToParseLatencies_;
        std::array<uint64_t, LATENCY_BUFFER_SIZE> parseToUpdateLatencies_;
        std::array<uint64_t, LATENCY_BUFFER_SIZE> orderRoundtripLatencies_;

        std::atomic<size_t> wsToParseIndex_{0};
        std::atomic<size_t> parseToUpdateIndex_{0};
        std::atomic<size_t> orderRoundtripIndex_{0};

        // ???????????????????????????????????????????????????????????????
        // Throughput Counters
        // ???????????????????????????????????????????????????????????????
        std::atomic<uint64_t> messagesReceived_{0};
        std::atomic<uint64_t> updatesProcessed_{0};
        std::atomic<uint64_t> ordersSubmitted_{0};

        std::atomic<uint64_t> lastMessagesReceived_{0};
        std::atomic<uint64_t> lastUpdatesProcessed_{0};
        std::atomic<uint64_t> lastOrdersSubmitted_{0};

        // ???????????????????????????????????????????????????????????????
        // Trading State
        // ???????????????????????????????????????????????????????????????
        std::atomic<double> realizedPnL_{0.0};
        std::atomic<double> unrealizedPnL_{0.0};
        std::atomic<double> currentExposure_{0.0};
        std::atomic<uint32_t> activeOrders_{0};

        // ???????????????????????????????????????????????????????????????
        // Risk State
        // ???????????????????????????????????????????????????????????????
        std::atomic<Trading::RiskState> riskState_{Trading::RiskState::Normal};
        std::atomic<double> dailyLossUsed_{0.0};
        std::atomic<double> positionUsed_{0.0};

        // ???????????????????????????????????????????????????????????????
        // Helpers
        // ???????????????????????????????????????????????????????????????
        uint64_t CalculatePercentile(const std::array<uint64_t, LATENCY_BUFFER_SIZE>& data,
                                     double percentile) const;
    };

} // namespace TradingBot::Core::Infrastructure
