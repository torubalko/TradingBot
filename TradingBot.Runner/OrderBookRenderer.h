#pragma once
#include <memory>
#include <vector>
#include <unordered_map>
#include "Graphics.h"
#include "../TradingBot.Core/SharedState.h"

// ???????????????????????????????????????????????????????????????
// OrderBookRenderer: GPU-accelerated визуализация Order Book
// 
// ОПТИМИЗАЦИИ:
// - Lock-free чтение из SharedState (не блокирует бот)
// - Batch rendering (один draw call для всех баров)
// - Pre-allocated буферы (zero allocations в render loop)
// - GPU instancing (минимальная нагрузка на CPU)
// ???????????????????????????????????????????????????????????????

class OrderBookRenderer {
public:
    OrderBookRenderer(Graphics* graphics, std::shared_ptr<TradingBot::Core::SharedState> sharedState);
    ~OrderBookRenderer();

    // Рендеринг Order Book (вызывается каждый кадр)
    void Render(float x, float y, float width, float height);

    // Настройки визуализации
    void SetDepth(int levels) { visibleLevels_ = levels; }
    void SetMaxBarWidth(float width) { maxBarWidth_ = width; }

private:
    // ???????????????????????????????????????????????????????????
    // Internal Rendering Methods
    // ???????????????????????????????????????????????????????????
    
    void RenderBids(float x, float y, float width, float height, 
                    const std::vector<std::pair<double, double>>& bids,
                    double maxVolume);
    
    void RenderAsks(float x, float y, float width, float height,
                    const std::vector<std::pair<double, double>>& asks,
                    double maxVolume);
    
    void RenderSpreadLine(float x, float y, float width, double bidPrice, double askPrice);
    
    std::vector<std::pair<double, double>> FillSide(const std::vector<std::pair<double, double>>& src,
                                                    bool descending,
                                                    double startPriceOverride = std::numeric_limits<double>::quiet_NaN()) const;
    
    double DetectPriceStep(const std::vector<std::pair<double, double>>& src) const;
    double DetectCommonStep(const std::vector<std::pair<double, double>>& bids,
                            const std::vector<std::pair<double, double>>& asks) const;
    
    // Расчёт максимального объёма для нормализации баров
    double CalculateMaxVolume(const std::vector<std::pair<double, double>>& bids,
                             const std::vector<std::pair<double, double>>& asks);

    // ???????????????????????????????????????????????????????????
    // Members
    // ???????????????????????????????????????????????????????????
    
    Graphics* graphics_;
    std::shared_ptr<TradingBot::Core::SharedState> sharedState_;
    
    // Настройки
    int visibleLevels_ = 20;        // Сколько уровней показывать
    float maxBarWidth_ = 300.0f;    // Максимальная ширина бара
    float levelHeight_ = 20.0f;     // Высота одного уровня
    
    // Pre-allocated буферы (для zero-allocation в render loop)
    std::vector<std::pair<double, double>> cachedBids_;
    std::vector<std::pair<double, double>> cachedAsks_;
    std::vector<std::pair<double, double>> filledBids_;
    std::vector<std::pair<double, double>> filledAsks_;
};
